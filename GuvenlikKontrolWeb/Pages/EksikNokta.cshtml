@page
@model GuvenlikKontrolWeb.Pages.EksikNoktaModel
@{
    ViewData["Title"] = "Eksik Nokta Analizi";
}

<style>
    /* Müşteri sayfası formatındaki butonlar [2026-02-25] */
    .btn-action {
        background: white;
        border: 1px solid #d1d3e2;
        color: #4e73df;
        font-weight: 600;
        transition: 0.3s;
        border-radius: 6px;
    }

        .btn-action:hover {
            background: #f8f9fc;
            border-color: #4e73df;
        }

    .section-title {
        border-left: 5px solid #e74c3c;
        padding-left: 15px;
        margin-bottom: 20px;
        color: #2c3e50;
        font-weight: 800;
    }

    .table thead th {
        background-color: #f8f9fc;
        text-transform: uppercase;
        font-size: 0.85rem;
        font-weight: 700;
        border-bottom: 2px solid #e3e6f0;
    }
</style>

<div class="container-fluid animate__animated animate__fadeIn py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="text-danger fw-bold m-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Eksik Kontrol Noktası Raporu</h4>
            <small id="seciliTarih" class="text-muted fw-bold"></small>
        </div>
        <div class="d-flex gap-2">
            <button onclick="window.print()" class="btn btn-sm btn-action shadow-sm px-3"><i class="bi bi-printer me-1"></i> Yazdır</button>
            <button onclick="exportToExcel()" class="btn btn-sm btn-action shadow-sm px-3 text-success"><i class="bi bi-file-earmark-excel me-1"></i> Excel</button>
            <button class="btn btn-sm btn-primary shadow-sm px-3" onclick="location.reload()"><i class="bi bi-funnel me-1"></i> Filtrele / Güncelle</button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
        <div class="card-header bg-white py-3 border-bottom">
            <h6 class="m-0 font-weight-bold text-dark"><i class="bi bi-graph-up-arrow me-2"></i>Günlük Eksik Geçiş Analizi (Personel Bazlı)</h6>
        </div>
        <div class="card-body">
            <div style="width:100%; height:320px;">
                <canvas id="grafikEksikNokta"></canvas>
            </div>
        </div>
    </div>

    <h4 class="section-title">Atlanan Kontrol Noktası Detayları</h4>
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0" id="eksikNoktaTablo">
                    <thead class="sticky-top">
                        <tr>
                            <th class="ps-4">Tur No</th>
                            <th>Bekçi Adı</th>
                            <th>Atlanan Kontrol Noktası</th>
                            <th>Tur Başlangıç Zamanı</th>
                            <th class="text-center">Durum</th>
                        </tr>
                    </thead>
                    <tbody id="eksikTableBody">
                        <tr><td colspan="5" class="text-center p-5 text-muted">Veriler analiz ediliyor, lütfen bekleyiniz...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script>
        async function eksikNoktaGetir() {
            const bas = localStorage.getItem("baslangic");
            const bit = localStorage.getItem("bitis");

            if (!bas || !bit) {
                document.getElementById("eksikTableBody").innerHTML = '<tr><td colspan="5" class="text-center p-5 text-warning">Lütfen tarih seçip güncelleyiniz.</td></tr>';
                return;
            }

            document.getElementById("seciliTarih").innerHTML = `📅 Dönem: ${formatDate(bas)} - ${formatDate(bit)}`;

            try {
                const res = await fetch(`/api/TurAnaliz?baslangic=${bas}&bitis=${bit}`);
                const data = await res.json();

                const beklenenNoktalar = ["İdari Bina","Shring Mak.","Kalite Kontrol","Eski Kazan Yıkama(Vernik)","Trafo","Pasta Dairesi","Alkid Zemin","Alkid 1.Kat","Alkid 2.Kat","Kazan Dairesi","İnşaat Su Deposu","İnşaat Arka","İnşaat Üretim Platform","İnşaat Ambalaj Depo","Atölye"];

                const eksikList = [];
                const turGruplar = {};

                data.forEach(row => {
                    if ((row.satirTipi || row.SatirTipi) === "DETAY") {
                        const key = `${row.turNo}|${row.bekciAdi}`;
                        if (!turGruplar[key]) turGruplar[key] = [];
                        turGruplar[key].push(row.kontrolNoktasiAdi);
                    }
                });

                Object.keys(turGruplar).forEach(key => {
                    const [turNo, bekci] = key.split("|");
                    const okutulan = turGruplar[key];

                    beklenenNoktalar.forEach(nokta => {
                        if (!okutulan.includes(nokta)) {
                            const tur = data.find(d => d.turNo == turNo && d.bekciAdi == bekci);
                            eksikList.push({
                                turNo: turNo,
                                bekci: bekci,
                                nokta: nokta,
                                zaman: tur ? tur.devriyeZamani : "",
                                tarih: tur ? tur.devriyeZamani.split("T")[0] : ""
                            });
                        }
                    });
                });

                renderTable(eksikList);
                renderChart(eksikList);

            } catch (err) { console.error("Hata:", err); }
        }

        function renderTable(list) {
            const tbody = document.getElementById("eksikTableBody");
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5 text-success fw-bold">✅ Harika! Tüm noktalar eksiksiz taranmış.</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(e => `
                <tr>
                    <td class="ps-4 fw-bold text-primary">#${e.turNo}</td>
                    <td><i class="bi bi-person-badge me-2"></i>${e.bekci}</td>
                    <td class="text-danger fw-bold">${e.nokta}</td>
                    <td class="text-muted">${formatDate(e.zaman)}</td>
                    <td class="text-center"><span class="badge rounded-pill bg-danger px-3">ATLANDI</span></td>
                </tr>
            `).join('');
        }

        function renderChart(eksikList) {
            const tarihler = [...new Set(eksikList.map(e => e.tarih))].sort();
            const bekciler = [...new Set(eksikList.map(e => e.bekci))];
            const renkPaleti = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74c3c', '#858796'];

            const datasets = bekciler.map((bekci, index) => ({
                label: bekci,
                data: tarihler.map(t => eksikList.filter(e => e.bekci === bekci && e.tarih === t).length),
                backgroundColor: renkPaleti[index % renkPaleti.length],
                borderRadius: 4,
                barPercentage: 0.6, // Barları daralttık
                categoryPercentage: 0.7
            }));

            const ctx = document.getElementById('grafikEksikNokta').getContext('2d');
            if (window.eksikChart) window.eksikChart.destroy();

            window.eksikChart = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels], // Data labels plugin aktif
                data: { labels: tarihler.map(t => new Date(t).toLocaleDateString("tr-TR")), datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true, font: { weight: 'bold' } } },
                        datalabels: { // Data Labels ayarları
                            anchor: 'end',
                            align: 'top',
                            color: '#2c3e50',
                            font: { weight: 'bold', size: 11 },
                            formatter: (v) => v > 0 ? v : ''
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2] }, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return "-";
            return new Date(dateString).toLocaleString("tr-TR", {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        document.addEventListener("DOMContentLoaded", eksikNoktaGetir);
    </script>
}