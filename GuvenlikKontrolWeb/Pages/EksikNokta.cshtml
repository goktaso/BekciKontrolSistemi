@page
@model GuvenlikKontrolWeb.Pages.EksikNoktaModel
@{
    ViewData["Title"] = "Eksik Nokta Analizi";
}

<div class="container-fluid animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="text-danger fw-bold m-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Eksik Kontrol Noktası Raporu</h4>
        <div id="seciliTarih" class="badge bg-white text-dark border shadow-sm p-2"></div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <h6 class="m-0 font-weight-bold text-dark"><i class="bi bi-graph-up-arrow me-2"></i>Günlük Eksik Geçiş Sayıları</h6>
        </div>
        <div class="card-body">
            <div style="width:100%; height:350px;">
                <canvas id="grafikEksikNokta"></canvas>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-danger text-white py-3">
            <h6 class="m-0 font-weight-bold">Atlanan Kontrol Noktası Detayları</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-hover align-middle mb-0" id="eksikNoktaTablo">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="ps-3">Tur No</th>
                            <th>Bekçi</th>
                            <th>Kontrol Noktası</th>
                            <th>Planlanan Zaman</th>
                            <th class="text-center">Durum</th>
                        </tr>
                    </thead>
                    <tbody id="eksikTableBody">
                        <tr><td colspan="5" class="text-center p-5 text-muted">Veriler analiz ediliyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Not: Chart.js ve DataLabels Layout'tan lokal olarak geliyor.

        async function eksikNoktaGetir() {
            const bas = localStorage.getItem("baslangic");
            const bit = localStorage.getItem("bitis");

            if (!bas || !bit) {
                document.getElementById("eksikTableBody").innerHTML = '<tr><td colspan="5" class="text-center p-5 text-warning">Lütfen sol menüden tarih seçip Raporu Güncelle butonuna basınız!</td></tr>';
                return;
            }

            document.getElementById("seciliTarih").innerHTML = `📅 Dönem: ${formatDate(bas)} - ${formatDate(bit)}`;

            try {
                const res = await fetch(`/api/TurAnaliz?baslangic=${bas}&bitis=${bit}`);
                const data = await res.json();

                // Beklenen noktalar listesi (Sabit)
                const beklenenNoktalar = [
                    "İdari Bina","Shring Mak.","Kalite Kontrol","Eski Kazan Yıkama(Vernik)",
                    "Trafo","Pasta Dairesi","Alkid Zemin","Alkid 1.Kat","Alkid 2.Kat",
                    "Kazan Dairesi","İnşaat Su Deposu","İnşaat Arka","İnşaat Üretim Platform",
                    "İnşaat Ambalaj Depo","Atölye"
                ];

                const eksikList = [];
                const turGruplar = {};

                // Veriyi tur bazlı grupla
                data.forEach(row => {
                    if ((row.satirTipi || row.SatirTipi) === "DETAY") {
                        const key = `${row.turNo}|${row.bekciAdi}`;
                        if (!turGruplar[key]) turGruplar[key] = [];
                        turGruplar[key].push(row.kontrolNoktasiAdi);
                    }
                });

                // Eksikleri tespit et
                Object.keys(turGruplar).forEach(key => {
                    const [turNo, bekci] = key.split("|");
                    const okutulan = turGruplar[key];

                    beklenenNoktalar.forEach(nokta => {
                        if (!okutulan.includes(nokta)) {
                            const tur = data.find(d => d.turNo == turNo && d.bekciAdi == bekci);
                            eksikList.push({
                                turNo: turNo,
                                bekci: bekci,
                                nokta: nokta,
                                zaman: tur ? tur.devriyeZamani : "",
                                tarih: tur ? tur.devriyeZamani.split("T")[0] : ""
                            });
                        }
                    });
                });

                renderTable(eksikList);
                renderChart(eksikList);

            } catch (err) {
                console.error("Veri çekme hatası:", err);
            }
        }

        function renderTable(list) {
            const tbody = document.getElementById("eksikTableBody");
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-5 text-success fw-bold">✅ Harika! Bu dönemde hiç eksik nokta bulunmuyor.</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(e => `
                <tr>
                    <td class="ps-3 fw-bold">#${e.turNo}</td>
                    <td><i class="bi bi-person me-2"></i>${e.bekci}</td>
                    <td class="text-danger fw-bold">${e.nokta}</td>
                    <td class="text-muted small">${formatDate(e.zaman)}</td>
                    <td class="text-center"><span class="badge bg-danger">EKSİK</span></td>
                </tr>
            `).join('');
        }

        function renderChart(eksikList) {
            const tarihler = [...new Set(eksikList.map(e => e.tarih))].sort();
            const bekciler = [...new Set(eksikList.map(e => e.bekci))];

            // Yüksek kontrastlı profesyonel renkler
            const renkPaleti = ['#e74c3c', '#3498db', '#f1c40f', '#9b59b6', '#1abc9c', '#e67e22'];

            const datasets = bekciler.map((bekci, index) => {
                return {
                    label: bekci,
                    data: tarihler.map(t => eksikList.filter(e => e.bekci === bekci && e.tarih === t).length),
                    backgroundColor: renkPaleti[index % renkPaleti.length],
                    borderRadius: 5
                };
            });

            const ctx = document.getElementById('grafikEksikNokta').getContext('2d');
            if (window.eksikChart) window.eksikChart.destroy();

            window.eksikChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: tarihler.map(t => new Date(t).toLocaleDateString("tr-TR")), datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: (v) => v > 0 ? v : ''
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return "-";
            return new Date(dateString).toLocaleString("tr-TR", {
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });
        }

        document.addEventListener("DOMContentLoaded", eksikNoktaGetir);
    </script>
}