@* @page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
}

<style>
    .chart-wrapper {
        position: relative;
        height: 320px;
        width: 100%;
    }

    .card-kpi {
        transition: all 0.3s ease;
        border: none;
        border-radius: 15px;
    }

    .card-kpi:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.1) !important;
    }

    .progress {
        background-color: #eaecf4;
        border-radius: 10px;
        height: 8px;
    }

    .table thead th {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        background-color: #f8f9fc;
    }

    .avatar-icon {
        display: inline-block;
        width: 35px;
        height: 35px;
        line-height: 35px;
        background-color: #f8f9fc;
        border-radius: 50%;
        text-align: center;
    }
</style>

<div class="container-fluid animate__animated animate__fadeIn">

    <div id="dashNoData" class="text-center py-5 shadow-sm bg-white rounded-4 mt-4" style="display: none; border: 2px dashed #dee2e6;">
        <div class="mb-4"><i class="bi bi-clipboard-data display-1 text-muted opacity-25"></i></div>
        <h3 class="fw-bold text-secondary">Dashboard Verisi Bekleniyor</h3>
        <p class="text-muted">Analiz sonuçlarını görmek için sol menüden raporu güncelleyiniz.</p>
    </div>

    <div id="dashContent" style="display: none;">

        <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
            <div>
                <h2 class="fw-bold text-dark m-0"><i class="bi bi-activity text-primary me-2"></i>Sistem Sağlık Paneli</h2>
                <small id="dashTarihLabel" class="text-muted"></small>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card card-kpi shadow-sm bg-primary text-white h-100">
                    <div class="card-body py-4">
                        <div class="small opacity-75 fw-bold">TOPLAM TUR</div>
                        <h2 class="fw-bold mb-0" id="dashTotalTours">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-kpi shadow-sm bg-info text-white h-100">
                    <div class="card-body py-4">
                        <div class="small opacity-75 fw-bold">OKUTULAN NOKTA</div>
                        <h2 class="fw-bold mb-0" id="dashTotalPoints">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-kpi shadow-sm bg-warning text-dark h-100">
                    <div class="card-body py-4">
                        <div class="small opacity-75 fw-bold">EKSİK OKUMA</div>
                        <h2 class="fw-bold mb-0" id="dashTotalMissing">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-kpi shadow-sm bg-dark text-white h-100">
                    <div class="card-body py-4">
                        <div class="small opacity-75 fw-bold">AKTİF PERSONEL</div>
                        <h2 class="fw-bold mb-0" id="dashGuardCount">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm h-100 rounded-4">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-primary">📈 Günlük Devriye Yoğunluğu</h6></div>
                    <div class="card-body">
                        <div class="chart-wrapper"><canvas id="dashLineChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card border-0 shadow-sm h-100 rounded-4">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-primary">🎯 Tur Başarı Oranı</h6></div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="chart-wrapper"><canvas id="dashQualityChart"></canvas></div>
                        <div id="qualityStats" class="text-center mt-3 small fw-bold"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card border-0 shadow-sm rounded-4 mb-4 h-100">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-danger">⚠️ Atlanan Noktalar</h6></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr><th class="ps-4">Nokta Adı</th><th class="text-center">Okunma</th><th class="pe-4">Verim</th></tr>
                                </thead>
                                <tbody id="missingPointsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card border-0 shadow-sm rounded-4 mb-4 h-100">
                    <div class="card-header bg-white py-3 border-0">
                        <h6 class="m-0 fw-bold text-primary">👮 Bekçi Performans Detay Listesi</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr class="text-secondary">
                                        <th class="ps-4">Bekçi Adı</th>
                                        <th class="text-center">Okunan</th>
                                        <th class="text-center">Skor</th>
                                        <th class="pe-4">Durum</th>
                                    </tr>
                                </thead>
                                <tbody id="guardPerformanceBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rawData = sessionStorage.getItem("turData");
            if (!rawData) {
                document.getElementById("dashNoData").style.display = "block";
            } else {
                document.getElementById("dashContent").style.display = "block";
                renderDashboard(JSON.parse(rawData));
            }
        });

        function renderDashboard(data) {
            const turlar = data.filter(x => x.satirTipi === "TOPLAM");
            const detaylar = data.filter(x => x.satirTipi === "DETAY");

            // KPI Hesaplamaları
            const expectedPointsPerTour = 15; 
            const totalExpected = turlar.length * expectedPointsPerTour;
            const actualPoints = detaylar.length;
            const missing = Math.max(0, totalExpected - actualPoints);

            document.getElementById("dashTotalTours").innerText = turlar.length;
            document.getElementById("dashTotalPoints").innerText = actualPoints;
            document.getElementById("dashTotalMissing").innerText = missing;
            document.getElementById("dashGuardCount").innerText = [...new Set(detaylar.map(x => x.bekciAdi))].length;

            const bas = localStorage.getItem("baslangic");
            const bit = localStorage.getItem("bitis");
            if(bas && bit) document.getElementById("dashTarihLabel").innerText = `${new Date(bas).toLocaleDateString('tr-TR')} - ${new Date(bit).toLocaleDateString('tr-TR')}`;

            renderLineChart(turlar);
            renderQualityChart(actualPoints, missing);
            renderMissingTable(detaylar, turlar.length);
            // Güncellenen fonksiyonu çağırıyoruz
            renderGuardDetailedPerformance(detaylar, turlar, expectedPointsPerTour);
        }

        function renderQualityChart(success, fail) {
            new Chart(document.getElementById("dashQualityChart"), {
                type: 'pie',
                data: {
                    labels: ['Başarılı Okuma', 'Atlanan Nokta'],
                    datasets: [{
                        data: [success, fail],
                        backgroundColor: ['#1cc88a', '#e74c3c'],
                        hoverOffset: 10
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            const ratio = Math.round((success / (success + fail)) * 100) || 0;
            document.getElementById("qualityStats").innerHTML = `Genel Operasyon Verimliliği: <span class="text-success">%${ratio}</span>`;
        }

        function renderLineChart(turlar) {
            const gunler = [...new Set(turlar.map(x => new Date(x.operasyonGunu).toLocaleDateString('tr-TR')))].sort();
            const counts = gunler.map(g => turlar.filter(x => new Date(x.operasyonGunu).toLocaleDateString('tr-TR') === g).length);

            new Chart(document.getElementById("dashLineChart"), {
                type: 'line',
                data: {
                    labels: gunler,
                    datasets: [{
                        label: 'Tamamlanan Tur',
                        data: counts,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function renderMissingTable(detaylar, totalTours) {
            const counts = {};
            detaylar.forEach(d => counts[d.kontrolNoktasiAdi] = (counts[d.kontrolNoktasiAdi] || 0) + 1);
            const sorted = Object.entries(counts).sort((a, b) => a[1] - b[1]).slice(0, 5);
            const tbody = document.getElementById("missingPointsBody");

            tbody.innerHTML = sorted.map(([nokta, sayi]) => {
                const verim = totalTours > 0 ? Math.round((sayi / totalTours) * 100) : 0;
                let color = verim < 50 ? 'danger' : (verim < 80 ? 'warning' : 'success');
                return `<tr><td class="ps-4 fw-bold small">${nokta}</td><td class="text-center small">${sayi}</td><td class="pe-4"><div class="progress"><div class="progress-bar bg-${color}" style="width: ${verim}%"></div></div></td></tr>`;
            }).join('');
        }

        // HESAPLAMA HATASI GİDERİLEN FONKSİYON
        function renderGuardDetailedPerformance(detaylar, turlar, expectedPerTour) {
            const bekciVerileri = {};

            // 1. Detaylardan okuma sayılarını al
            detaylar.forEach(d => {
                const isim = d.bekciAdi || "Bilinmeyen";
                if (!bekciVerileri[isim]) {
                    bekciVerileri[isim] = { okuma: 0, turSayisi: 0 };
                }
                bekciVerileri[isim].okuma++;
            });

            // 2. Tur sayılarını turlar dizisinden eşleştir
            turlar.forEach(t => {
                const isim = t.bekciAdi;
                if (isim && bekciVerileri[isim]) {
                    bekciVerileri[isim].turSayisi++;
                }
            });

            const tbody = document.getElementById("guardPerformanceBody");
            tbody.innerHTML = Object.entries(bekciVerileri).map(([name, stats]) => {
                // Tur sayısı veriden gelmiyorsa (sıfırsa), okunan veriye göre tahmin et (0'a bölmeyi engelle)
                const tSayisi = stats.turSayisi > 0 ? stats.turSayisi : Math.ceil(stats.okuma / expectedPerTour);
                const toplamBeklenen = tSayisi * expectedPerTour;
                
                const performans = toplamBeklenen > 0 ? Math.round((stats.okuma / toplamBeklenen) * 100) : 0;
                
                let colorClass = performans >= 90 ? "success" : (performans >= 70 ? "info" : (performans >= 50 ? "warning" : "danger"));

                return `
                    <tr>
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="avatar-icon me-2"><i class="bi bi-person text-primary"></i></div>
                                <span class="fw-bold small">${name}</span>
                            </div>
                        </td>
                        <td class="text-center small"><strong>${stats.okuma}</strong>/${toplamBeklenen}</td>
                        <td class="text-center"><span class="badge bg-${colorClass}">%${performans}</span></td>
                        <td class="pe-4">
                            <div class="progress" style="height: 6px; width: 80px;">
                                <div class="progress-bar bg-${colorClass}" style="width: ${performans}%"></div>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        }
    </script>
} *@



@page
@model IndexModel
@{
    ViewData["Title"] = "Dashboard";
    // Razor motorunun @media ile karışmasını önlemek için kaçış karakteri
    string mediaQuery = "@media";
}

<style>
    .chart-wrapper {
        position: relative;
        height: 300px;
        width: 100%;
    }

    .card-kpi {
        transition: all 0.3s ease;
        border: none;
        border-radius: 12px;
        margin-bottom: 10px;
    }

    .responsive-table-container {
        overflow-x: auto;
        display: block;
        width: 100%;
        -webkit-overflow-scrolling: touch;
    }

    .progress {
        background-color: #eaecf4;
        border-radius: 10px;
        height: 8px;
    }

    /* Build hatasını önleyen güvenli medya sorgusu yazımı */
    @Html.Raw(mediaQuery) (max-width: 768px) {
        .responsive-font

    {
        font-size: 0.8rem !important;
    }

    .card-body {
        padding: 0.75rem;
    }

    .chart-wrapper {
        height: 250px;
    }

    h2 {
        font-size: 1.4rem;
    }

    }
</style>

<div class="container-fluid animate__animated animate__fadeIn px-2 px-md-4">

    <div id="dashNoData" class="text-center py-5 shadow-sm bg-white rounded-4 mt-4" style="display: none; border: 2px dashed #dee2e6;">
        <div class="mb-4"><i class="bi bi-clipboard-data display-1 text-muted opacity-25"></i></div>
        <h3 class="fw-bold text-secondary">Veri Bekleniyor</h3>
        <p class="text-muted">Analiz sonuçlarını görmek için sol menüden raporu güncelleyiniz.</p>
    </div>

    <div id="dashContent" style="display: none;">

        <div class="row mb-4 mt-3 text-center text-md-start">
            <div class="col-12">
                <h2 class="fw-bold text-dark m-0"><i class="bi bi-activity text-primary me-2"></i>Sistem Sağlık Paneli</h2>
                <small id="dashTarihLabel" class="text-muted d-block mt-1"></small>
            </div>
        </div>

        <div class="row g-2 g-md-3 mb-4 text-center">
            <div class="col-6 col-md-3">
                <div class="card card-kpi shadow-sm bg-primary text-white h-100">
                    <div class="card-body py-3">
                        <div class="small opacity-75 fw-bold">TOPLAM TUR</div>
                        <h2 class="fw-bold mb-0" id="dashTotalTours">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-kpi shadow-sm bg-info text-white h-100">
                    <div class="card-body py-3">
                        <div class="small opacity-75 fw-bold">OKUTULAN</div>
                        <h2 class="fw-bold mb-0" id="dashTotalPoints">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-kpi shadow-sm bg-warning text-dark h-100">
                    <div class="card-body py-3">
                        <div class="small opacity-75 fw-bold">EKSİK</div>
                        <h2 class="fw-bold mb-0" id="dashTotalMissing">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card card-kpi shadow-sm bg-dark text-white h-100">
                    <div class="card-body py-3">
                        <div class="small opacity-75 fw-bold">PERSONEL</div>
                        <h2 class="fw-bold mb-0" id="dashGuardCount">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-12 col-lg-7">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-primary">📈 Günlük Yoğunluk</h6></div>
                    <div class="card-body">
                        <div class="chart-wrapper"><canvas id="dashLineChart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-5">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-primary">🎯 Başarı Oranı</h6></div>
                    <div class="card-body text-center">
                        <div class="chart-wrapper"><canvas id="dashQualityChart"></canvas></div>
                        <div id="qualityStats" class="mt-3 small fw-bold"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-12 col-xl-5">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-danger">⚠️ Atlanan Noktalar</h6></div>
                    <div class="card-body p-0 responsive-table-container">
                        <table class="table table-hover align-middle mb-0 responsive-font">
                            <thead class="bg-light">
                                <tr><th class="ps-3">Nokta</th><th class="text-center">Okunma</th><th class="pe-3 text-end">Verim</th></tr>
                            </thead>
                            <tbody id="missingPointsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-7">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-white py-3 border-0"><h6 class="m-0 fw-bold text-primary">👮 Bekçi Performans Detayı</h6></div>
                    <div class="card-body p-0 responsive-table-container">
                        <table class="table table-hover align-middle mb-0 responsive-font">
                            <thead class="bg-light">
                                <tr><th class="ps-3">Bekçi</th><th class="text-center">Okunan</th><th class="text-center">Skor</th><th class="pe-3">Durum</th></tr>
                            </thead>
                            <tbody id="guardPerformanceBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const rawData = sessionStorage.getItem("turData");
            if (!rawData) {
                document.getElementById("dashNoData").style.display = "block";
            } else {
                document.getElementById("dashContent").style.display = "block";
                renderDashboard(JSON.parse(rawData));
            }
        });

        function renderDashboard(data) {
            const turlar = data.filter(x => x.satirTipi === "TOPLAM");
            const detaylar = data.filter(x => x.satirTipi === "DETAY");

            const expectedPointsPerTour = 15;
            const totalExpected = turlar.length * expectedPointsPerTour;
            const actualPoints = detaylar.length;
            const missing = Math.max(0, totalExpected - actualPoints);

            document.getElementById("dashTotalTours").innerText = turlar.length;
            document.getElementById("dashTotalPoints").innerText = actualPoints;
            document.getElementById("dashTotalMissing").innerText = missing;
            document.getElementById("dashGuardCount").innerText = [...new Set(detaylar.map(x => x.bekciAdi))].length;

            renderLineChart(turlar);
            renderQualityChart(actualPoints, missing);
            renderMissingTable(detaylar, turlar.length);
            renderGuardDetailedPerformance(detaylar, turlar, expectedPointsPerTour);
        }

        function renderQualityChart(success, fail) {
            new Chart(document.getElementById("dashQualityChart"), {
                type: 'pie',
                data: {
                    labels: ['Başarılı', 'Eksik'],
                    datasets: [{ data: [success, fail], backgroundColor: ['#1cc88a', '#e74c3c'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
            const ratio = Math.round((success / (success + fail)) * 100) || 0;
            document.getElementById("qualityStats").innerHTML = `Genel Başarı: <span class="text-success">%${ratio}</span>`;
        }

        function renderLineChart(turlar) {
            const gunler = [...new Set(turlar.map(x => new Date(x.operasyonGunu).toLocaleDateString('tr-TR')))].sort();
            const counts = gunler.map(g => turlar.filter(x => new Date(x.operasyonGunu).toLocaleDateString('tr-TR') === g).length);

            new Chart(document.getElementById("dashLineChart"), {
                type: 'line',
                data: {
                    labels: gunler,
                    datasets: [{ label: 'Günlük Tur', data: counts, borderColor: '#4e73df', backgroundColor: 'rgba(78, 115, 223, 0.05)', fill: true, tension: 0.4 }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function renderMissingTable(detaylar, totalTours) {
            const counts = {};
            detaylar.forEach(d => counts[d.kontrolNoktasiAdi] = (counts[d.kontrolNoktasiAdi] || 0) + 1);
            const sorted = Object.entries(counts).sort((a, b) => a[1] - b[1]).slice(0, 5);
            const tbody = document.getElementById("missingPointsBody");

            tbody.innerHTML = sorted.map(([nokta, sayi]) => {
                const verim = totalTours > 0 ? Math.round((sayi / totalTours) * 100) : 0;
                let color = verim < 50 ? 'danger' : (verim < 80 ? 'warning' : 'success');
                return `<tr>
                    <td class="ps-3 fw-bold small text-truncate" style="max-width:140px;">${nokta}</td>
                    <td class="text-center small">${sayi}</td>
                    <td class="pe-3 text-end"><div class="progress ms-auto" style="width:60px; height:6px;"><div class="progress-bar bg-${color}" style="width: ${verim}%"></div></div></td>
                </tr>`;
            }).join('');
        }

        function renderGuardDetailedPerformance(detaylar, turlar, expectedPerTour) {
            const bekciVerileri = {};
            detaylar.forEach(d => {
                const isim = d.bekciAdi || "Bilinmeyen";
                if (!bekciVerileri[isim]) bekciVerileri[isim] = { okuma: 0, turSayisi: 0 };
                bekciVerileri[isim].okuma++;
            });
            turlar.forEach(t => { if (t.bekciAdi && bekciVerileri[t.bekciAdi]) bekciVerileri[t.bekciAdi].turSayisi++; });

            const tbody = document.getElementById("guardPerformanceBody");
            tbody.innerHTML = Object.entries(bekciVerileri).map(([name, stats]) => {
                const tSayisi = stats.turSayisi > 0 ? stats.turSayisi : Math.ceil(stats.okuma / expectedPerTour);
                const toplamBeklenen = tSayisi * expectedPerTour;
                const performans = toplamBeklenen > 0 ? Math.round((stats.okuma / toplamBeklenen) * 100) : 0;
                let colorClass = performans >= 90 ? "success" : (performans >= 50 ? "warning" : "danger");

                return `<tr>
                    <td class="ps-3 fw-bold small">${name}</td>
                    <td class="text-center small">${stats.okuma}/${toplamBeklenen}</td>
                    <td class="text-center"><span class="badge bg-${colorClass}">%${performans}</span></td>
                    <td class="pe-3"><div class="progress ms-auto" style="width:40px; height:4px;"><div class="progress-bar bg-${colorClass}" style="width: ${performans}%"></div></div></td>
                </tr>`;
            }).join('');
        }
    </script>
}