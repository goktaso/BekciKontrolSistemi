@page
@model GuvenlikKontrolWeb.Pages.TurAnalizModel
@{
    ViewData["Title"] = "Tur Analiz";
}

<h2>Tur Analiz Raporu</h2>

<div id="seciliTarih" class="mb-3 fw-bold"></div>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Tur No</th>
                <th>No</th>
                <th>Bekçi</th>
                <th>Kontrol Noktası</th>
                <th>Devriye Saati</th>
                <th>İki Nokta Arası</th>
                <th>İki Tur Arası</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <tr>
                <td colspan="8" class="text-center">Veri yükleniyor...</td>
            </tr>
        </tbody>
    </table>
</div>

@section Scripts {

    <script>

        async function loadTurAnaliz() {

            const bas = localStorage.getItem("baslangic");
            const bit = localStorage.getItem("bitis");

            if (!bas || !bit) {
                document.getElementById("seciliTarih").innerHTML =
                    "Lütfen sol menüden tarih seçip raporu getiriniz.";

                document.getElementById("tableBody").innerHTML =
                    `<tr><td colspan="8" class="text-center">Veri bulunamadı.</td></tr>`;
                return;
            }

            document.getElementById("seciliTarih").innerHTML =
                `Seçilen Aralık: ${formatDate(bas)} - ${formatDate(bit)}`;

            try {

                const response = await fetch(`/api/TurAnaliz?baslangic=${bas}&bitis=${bit}`);

                if (!response.ok) {
                    throw new Error("API Hatası");
                }

                const data = await response.json();
                const tableBody = document.getElementById("tableBody");

                tableBody.innerHTML = "";

                if (!data || data.length === 0) {
                    tableBody.innerHTML =
                        `<tr><td colspan="8" class="text-center">Veri bulunamadı.</td></tr>`;
                    return;
                }

                data.forEach(row => {

                    // TOPLAM SATIRI
                    if (row.satirTipi === "TOPLAM") {

                        tableBody.innerHTML += `
                            <tr style="background-color:rgb(255,255,153); font-weight:bold;">
                                <td></td>
                                <td>${row.turNo ?? ''}</td>
                                <td></td>
                                <td></td>
                                <td>Tur ${row.turNo} Toplam</td>
                                <td></td>
                                <td>${formatDuration(row.turToplamSn)}</td>
                                <td>${formatDuration(row.ikiTurArasiSn)}</td>
                            </tr>
                        `;

                    } else {

                        tableBody.innerHTML += `
                            <tr>
                                <td>${formatOnlyDate(row.operasyonGunu)}</td>
                                <td>${row.turNo ?? ''}</td>
                                <td>${row.turIciNo ?? ''}</td>
                                <td>${row.bekciAdi ?? ''}</td>
                                <td>${row.kontrolNoktasiAdi ?? ''}</td>
                                <td>${formatOnlyTime(row.devriyeZamani)}</td>
                                <td>${formatDuration(row.ikiNoktaArasiSn)}</td>
                                <td></td>
                            </tr>
                        `;
                    }
                });

            } catch (err) {

                document.getElementById("tableBody").innerHTML =
                    `<tr><td colspan="8" class="text-danger text-center">Hata oluştu</td></tr>`;
            }
        }

        function formatDuration(seconds) {
            if (!seconds || seconds <= 0) return "00:00:00";

            const h = Math.floor(seconds / 3600).toString().padStart(2,'0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2,'0');
            const s = Math.floor(seconds % 60).toString().padStart(2,'0');

            return `${h}:${m}:${s}`;
        }

        function formatOnlyDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('tr-TR');
        }

        function formatOnlyTime(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleTimeString('tr-TR', { hour12:false });
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleString('tr-TR');
        }

        document.addEventListener("DOMContentLoaded", loadTurAnaliz);

    </script>

}