@page
@model IndexModel
@{
    ViewData["Title"] = "Güvenlik Operasyon Merkezi";
}

@* ... CSS ve HTML kısımların aynı kalıyor ... *@

<div class="container-fluid py-4">
    @* --- ÜST KARTLAR --- *@
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card dashboard-card p-3 border-left-primary h-100">
                <div class="stat-label">Toplam Okutma</div>
                <div class="stat-value" id="statNokta">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card bg-danger text-white p-3 h-100 shadow">
                <div class="small fw-bold text-uppercase opacity-75">Atılmayan Tur</div>
                <div class="stat-value text-white" id="statEksik">0</div>
            </div>
        </div>
        <div class="col-md-3">
            @* BURASI: Linki senin yeni sayfana (MukerrerNoktalar) yönlendirdim *@
            <div class="card dashboard-card p-3 border-left-warning h-100 shadow-sm" style="cursor:pointer" onclick="window.location.href='/MukerrerNoktalar'">
                <div class="stat-label text-warning">Mükerrer Okutma</div>
                <div class="stat-value" id="statMukerrer">0</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card dashboard-card p-3 border-left-success h-100">
                <div class="stat-label text-success">Başarı Oranı</div>
                <div class="stat-value" id="statOran">0%</div>
            </div>
        </div>
    </div>

    @* ... Orta grafik ve Atılmayan tur saatleri kısımları aynı ... *@

    @* Alt Tablo *@
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 fw-bold text-primary">Performans Detay Verileri (Aktif Personel)</h6>
                    @* TALİMAT: Müşteri sayfasındaki buton formatını buraya da ekledim *@
                    <div>
                        <button onclick="window.print()" class="btn btn-sm btn-light border"><i class="bi bi-printer"></i></button>
                        <button onclick="exportTableToExcel()" class="btn btn-sm btn-light border text-success"><i class="bi bi-file-earmark-excel"></i></button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 performance-table" id="perfTable">
                            <thead>
                                <tr>
                                    <th class="ps-4">Bekçi Adı</th>
                                    <th class="text-center">Toplam Tur</th>
                                    <th class="text-center text-success">Eksiksiz Tur</th>
                                    <th class="text-center text-danger">Mükerrer Sayısı</th> @* Burayı anlamlı hale getirdik *@
                                    <th class="text-center" style="width: 250px;">Başarı Oranı</th>
                                </tr>
                            </thead>
                            <tbody id="bekciKarneBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <script>
        Chart.register(ChartDataLabels);
        let myChart = null;

        document.addEventListener("DOMContentLoaded", () => {
            const data = JSON.parse(sessionStorage.getItem("turData") || "[]");
            if (data.length > 0) processDashboard(data);
        });

        function processDashboard(data) {
            // Sınırları belirleme (mevcut mantığın)
            const zamanlar = data.map(x => new Date(x.devriyeZamani)).filter(d => !isNaN(d));
            const baslangicSiniri = new Date(Math.min(...zamanlar));
            const bitisSiniri = new Date(Math.max(...zamanlar));

            let gunlukTurlar = {};
            let eksikSaatler = [];
            let bekciStats = {};
            let mukerrerSayaci = 0;
            let mukerrerKayitlar = {};

            data.forEach(item => {
                if (item.satirTipi === "TOPLAM") return;

                const isim = item.bekciAdi?.trim() || "Bilinmeyen";
                if(isim !== "---") {
                    if(!bekciStats[isim]) bekciStats[isim] = { toplamTur: 0, eksiksizTur: 0, mukerrerCount: 0 };
                }

                // --- MÜKERRER KONTROLÜ (DÜZELTİLDİ) ---
                // Mantık: Aynı turNo içinde aynı kontrolNoktasiAdi tekrar etmiş mi?
                const mKey = item.turNo + "_" + (item.kontrolNoktasiAdi || "").trim();
                if (!mukerrerKayitlar[mKey]) {
                    mukerrerKayitlar[mKey] = 1;
                } else {
                    mukerrerKayitlar[mKey]++;
                    mukerrerSayaci++; // Genel sayaç
                    if(bekciStats[isim]) bekciStats[isim].mukerrerCount++; // Bekçi bazlı sayaç
                }
            });

            // --- TUR ANALİZİ VE EKSİKLER (Mevcut mantığın korunarak iyileştirilmesi) ---
            let atilanTotal = 0; let atilmayanTotal = 0;
            let tempZaman = new Date(baslangicSiniri);
            tempZaman.setMinutes(0, 0, 0);

            while (tempZaman <= bitisSiniri) {
                const saat = tempZaman.getHours();
                const gunKey = tempZaman.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit' });
                if (!gunlukTurlar[gunKey]) gunlukTurlar[gunKey] = 0;

                const alt = new Date(tempZaman.getTime() - 15 * 60000);
                const ust = new Date(tempZaman.getTime() + 15 * 60000);

                const bulundu = data.find(x => {
                    let z = new Date(x.devriyeZamani);
                    return x.satirTipi !== "TOPLAM" && z >= alt && z <= ust;
                });

                if (bulundu) {
                    atilanTotal++;
                    gunlukTurlar[gunKey]++;
                    const isim = bulundu.bekciAdi?.trim() || "Bilinmeyen";
                    if (bekciStats[isim]) {
                        bekciStats[isim].toplamTur++;
                        bekciStats[isim].eksiksizTur++;
                    }
                } else {
                    atilmayanTotal++;
                    eksikSaatler.push({
                        tarih: gunKey,
                        saat: tempZaman.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })
                    });
                }
                tempZaman.setHours(tempZaman.getHours() + 1);
            }

            // --- UI GÜNCELLEME ---
            document.getElementById('statNokta').innerText = data.filter(x => x.satirTipi !== "TOPLAM").length;
            document.getElementById('statEksik').innerText = atilmayanTotal;
            document.getElementById('statMukerrer').innerText = mukerrerSayaci;
            document.getElementById('badgeEksikSayisi').innerText = atilmayanTotal;

            let basariOrani = (atilanTotal + atilmayanTotal) > 0 ? Math.round((atilanTotal / (atilanTotal + atilmayanTotal)) * 100) : 0;
            document.getElementById('statOran').innerText = basariOrani + "%";

            // Eksik turlar listesi
            document.getElementById('missedToursList').innerHTML = eksikSaatler.reverse().slice(0, 20).map(item => `
                <div class="missed-tour-item">
                    <span class="text-muted small fw-bold">${item.tarih}</span>
                    <span class="missed-tour-time">${item.saat}</span>
                </div>
            `).join('') || '<div class="text-center py-5 text-success">Tüm turlar tamam!</div>';

            // Bekçi Karne Body
            document.getElementById('bekciKarneBody').innerHTML = Object.keys(bekciStats).map(name => {
                const s = bekciStats[name];
                let basari = s.toplamTur > 0 ? Math.round((s.eksiksizTur / (s.toplamTur + (s.mukerrerCount * 0.1))) * 100) : 0; // Mükerrer başarıyı hafif etkilesin
                if(basari > 100) basari = 100;

                return `
                    <tr>
                        <td class="ps-4"><div class="bekci-adi">${name}</div></td>
                        <td class="text-center fw-bold">${s.toplamTur}</td>
                        <td class="text-center text-success fw-bold">${s.eksiksizTur}</td>
                        <td class="text-center text-danger fw-bold">${s.mukerrerCount}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2 fw-bold" style="min-width:45px;">%${basari}</span>
                                <div class="progress flex-grow-1">
                                    <div class="progress-bar ${basari >= 90 ? 'bg-success' : 'bg-warning'}" style="width: ${basari}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
            }).join('');

            updateChart(gunlukTurlar);
        }

        // Grafik fonksiyonun aynı kalıyor...
        function updateChart(chartData) {
            const ctx = document.getElementById('chartGunlukTur').getContext('2d');
            if (myChart) myChart.destroy();
            const labels = Object.keys(chartData);
            const values = Object.values(chartData);
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Atılan Tur Sayısı',
                        data: values,
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
}