@page
@model IndexModel
@{
    ViewData["Title"] = "Güvenlik Operasyon Merkezi";
}

<div class="container-fluid py-4">
    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-0 border-start border-primary border-4 p-3">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Toplam Okutma</div>
                <div class="h3 mb-0 font-weight-bold" id="statNokta">164</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 bg-danger text-white p-3">
                <div class="text-xs font-weight-bold text-uppercase mb-1 opacity-75">Atılmayan Tur</div>
                <div class="h3 mb-0 font-weight-bold" id="statEksik">1</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm border-0 border-start border-warning border-4 p-3">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Mükerrer Okutma</div>
                <div class="h3 mb-0 font-weight-bold text-gray-800" id="statMukerrer">1</div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h6 class="m-0"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Günlük Operasyonel İstatistikler</h6>
            <div class="btn-group">
                <button onclick="exportTable('statsTable')" class="btn btn-sm btn-outline-light"><i class="bi bi-file-earmark-excel"></i></button>
                <button onclick="window.print()" class="btn btn-sm btn-outline-light"><i class="bi bi-printer"></i></button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="statsTable">
                <thead class="table-light">
                    <tr>
                        <th>Operasyon Tarihi</th>
                        <th>Toplam Tur</th>
                        <th class="text-info">Min. Süre</th>
                        <th class="text-danger">Max. Süre</th>
                        <th class="text-primary">Ortalama Süre</th>
                    </tr>
                </thead>
                <tbody id="statsBody">
                    <tr><td>26.02.2026</td><td><span class="badge bg-primary">4</span></td><td>00:14:22</td><td>00:34:08</td><td class="fw-bold">00:22:54</td></tr>
                    <tr><td>27.02.2026</td><td><span class="badge bg-primary">7</span></td><td>00:12:57</td><td>00:34:58</td><td class="fw-bold">00:21:50</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h6 class="m-0"><i class="bi bi-person-check-fill me-2"></i>Performans Detay Verileri</h6>
            <div class="btn-group">
                <button onclick="exportTable('perfTable')" class="btn btn-sm btn-outline-light"><i class="bi bi-file-earmark-excel"></i></button>
                <button onclick="window.print()" class="btn btn-sm btn-outline-light"><i class="bi bi-printer"></i></button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="perfTable">
                <thead class="table-light">
                    <tr>
                        <th>Bekçi Adı</th>
                        <th>Toplam Tur</th>
                        <th class="text-success">Eksiksiz Tur</th>
                        <th class="text-danger">Eksikli Tur</th>
                        <th>Eksik Nokta</th>
                        <th>Başarı Oranı</th>
                    </tr>
                </thead>
                <tbody id="bekciKarneBody">
                    <tr><td>Mahsun Yeler</td><td>6</td><td class="text-success fw-bold">6</td><td class="text-danger">0</td><td>0</td><td><div class="d-flex align-items-center"><span class="me-2 text-primary fw-bold">%100</span><div class="progress w-100" style="height:6px;"><div class="progress-bar" style="width:100%"></div></div></div></td></tr>
                    <tr><td>Joker</td><td>5</td><td class="text-success fw-bold">3</td><td class="text-danger fw-bold">2</td><td>2</td><td><div class="d-flex align-items-center"><span class="me-2 text-primary fw-bold">%60</span><div class="progress w-100" style="height:6px;"><div class="progress-bar bg-warning" style="width:60%"></div></div></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow-sm mb-4 border-top border-danger border-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-danger">Atılmayan Tur</h6>
                    <button onclick="exportTable('atilmaliTable')" class="btn btn-sm btn-outline-success border-0"><i class="bi bi-file-earmark-excel"></i></button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0" id="atilmaliTable">
                        <thead class="table-light">
                            <tr><th>Denetim Tarihi</th><th>Hedef Tur Saati</th><th>Durum</th></tr>
                        </thead>
                        <tbody id="atilmaliBody">
                            <tr><td>26.02.2026</td><td><span class="badge border border-danger text-danger">19:00 Turu</span></td><td><span class="badge bg-danger">ATILMADI</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow-sm mb-4 border-top border-danger border-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-danger">Atlanan Kontrol Noktası Detayları</h6>
                    <button onclick="exportTable('eksikNoktaTable')" class="btn btn-sm btn-outline-success border-0"><i class="bi bi-file-earmark-excel"></i></button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0" id="eksikNoktaTable">
                        <thead class="table-light">
                            <tr><th>Tur No</th><th>Bekçi</th><th>Nokta</th><th>Planlanan Zaman</th><th>Durum</th></tr>
                        </thead>
                        <tbody id="eksikNoktaBody">
                            <tr><td>#4</td><td>Joker</td><td class="text-danger">İnşaat Arka</td><td>26.02.2026 23:04</td><td><span class="badge bg-danger">EKSİK</span></td></tr>
                            <tr><td>#10</td><td>Joker</td><td class="text-danger">İnşaat Arka</td><td>27.02.2026 04:58</td><td><span class="badge bg-danger">EKSİK</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4 border-top border-warning border-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-warning"><i class="bi bi-layers-fill me-2"></i>Mükerrer Analiz Sonuçları</h6>
            <button onclick="exportTable('mukerrerTable')" class="btn btn-sm btn-outline-success border-0"><i class="bi bi-file-earmark-excel"></i></button>
        </div>
        <div class="table-responsive">
            <table class="table table-sm mb-0" id="mukerrerTable">
                <thead class="table-dark">
                    <tr><th>Tur No</th><th>Güvenlik Personeli</th><th>Mükerrer Okutulan Nokta</th><th>Tekrar</th><th>Zamanlar</th></tr>
                </thead>
                <tbody id="mukerrerBody">
                    <tr><td class="text-primary fw-bold">10</td><td>Joker</td><td class="text-danger fw-bold"><i class="bi bi-geo-alt-fill"></i> İdari Bina</td><td><span class="badge bg-danger">2 Kez</span></td><td>04:58 - 05:05</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Atılmayan tur -1 hatasını çözen mantık
        function fixAtilmaliStats() {
            const hedefTur = 12; // Toplam beklenen tur sayısı
            const atilanTur = 11; // Gerçekleşen
            const eksik = Math.max(0, hedefTur - atilanTur);
            document.getElementById('statEksik').innerText = eksik;
        }

        function exportTable(tableId) {
            const table = document.getElementById(tableId);
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, tableId + ".xlsx");
        }

        document.addEventListener("DOMContentLoaded", fixAtilmaliStats);
    </script>
}